import React, { useState, useEffect } from "react";
import { ImCross } from "react-icons/im";
import { Button, Pagination } from "@mui/material";
import { useDispatch, useSelector } from "react-redux";
import { toggleShowAddAdminPermissionModal } from "../../store/slices/ModalManager";
import ModalTemplate from "./ModalTemplate";

// Custom hooks and components
import usePaginationHandler from "../../hooks/usePaginationHandler";
import CloudCoreSearchBar from "../../components/CustomStyledComponents/CloudSearchBar";
import AddPermissionToCartTitle from "../../PermissionComponents/AddPermissionToCartTitle";

// API hook to fetch all universal permissions
import { useGetAllUniversalPermissionsQuery } from "../../services/TeamsApiService";

// Import external Tailwind CSS file (see CSS file below)
import "../../css/AddPermissionModal.css";

const AddPermissionModalFromDB = () => {
  const dispatch = useDispatch();

  const modalHeading = useSelector(
    (state) => state.modalManager.addAdminPermissionModal.heading
  );
  const show = useSelector(
    (state) => state.modalManager.addAdminPermissionModal.show
  );

  if (!show) return null;

  // Use the custom pagination hook (returns an array)
  const [{ page, rowsPerPage }, resetPages, handleChangePage] =
    usePaginationHandler();
  // Force rows per page to be 4
  const fixedRowsPerPage = 4;

  const [searchValue, setSearchValue] = useState("");
  const [selectedPermissions, setSelectedPermissions] = useState([]);
  const [filteredPermissions, setFilteredPermissions] = useState([]);

  // Fetch permissions from the DB
  const { data: allPermissions = [], isLoading: permissionsLoading } =
    useGetAllUniversalPermissionsQuery();

  // Filter permissions based on search query
  useEffect(() => {
    if (allPermissions && !permissionsLoading) {
      const formattedSearch = searchValue.toLowerCase();
      const filtered = allPermissions.filter((permission) => {
        const nameMatched = permission.name.toLowerCase().includes(formattedSearch);
        const descriptionMatched = permission.description.toLowerCase().includes(formattedSearch);
        return nameMatched || descriptionMatched;
      });
      setFilteredPermissions(filtered);
      resetPages();
    }
  }, [searchValue, allPermissions, permissionsLoading, resetPages]);

  // Calculate total pages using fixedRowsPerPage (4)
  const totalPages = Math.ceil(filteredPermissions.length / fixedRowsPerPage);

  // Render permission tiles for the current page
  const permissionsOnCurrentPage = () => {
    if (filteredPermissions.length > 0 || !permissionsLoading) {
      const startIndex = fixedRowsPerPage * (page - 1);
      const endIndex = Math.min(filteredPermissions.length, fixedRowsPerPage * page);
      return filteredPermissions.slice(startIndex, endIndex).map((permission) => (
        <AddPermissionToCartTitle
          key={`db-permission-${permission.id}`}
          isLoading={permissionsLoading}
          permission={permission}
          permissionSelected={selectedPermissions.some(
            (perm) => perm.name === permission.name
          )}
          togglePermission={() => {
            let updatedSelected = [...selectedPermissions];
            const index = updatedSelected.findIndex(
              (perm) => perm.name === permission.name
            );
            if (index !== -1) {
              updatedSelected.splice(index, 1);
            } else {
              updatedSelected.push({ name: permission.name });
            }
            setSelectedPermissions(updatedSelected);
          }}
        />
      ));
    } else {
      return (
        <div className="no-permissions">
          <span className="no-permissions-text">No permissions found</span>
        </div>
      );
    }
  };

  const closeModalCallback = () => {
    dispatch(toggleShowAddAdminPermissionModal({ show: false }));
  };

  return (
    <ModalTemplate closeModalCallback={closeModalCallback}>
      <div className="modal-container">
        {/* Modal Header */}
        <div className="modal-header">
          <div className="modal-title">{modalHeading}</div>
          <ImCross onClick={closeModalCallback} className="modal-close" />
        </div>

        {/* Modal Body */}
        <div className="modal-body">
          <div className="modal-search-pagination">
            <CloudCoreSearchBar
              placeholder="Permission name"
              disabled={filteredPermissions.length === 0 && searchValue.length === 0}
              searchValue={searchValue}
              setSearchValue={(e) => setSearchValue(e.target.value)}
            />
            <Pagination
              variant="outlined"
              shape="rounded"
              boundaryCount={1}
              siblingCount={1}
              page={page}
              onChange={handleChangePage}
              count={totalPages}
              showFirstButton
              showLastButton
            />
          </div>
          <div className="modal-content">
            {permissionsOnCurrentPage()}
          </div>
        </div>

        {/* Modal Footer */}
        <div className="modal-footer">
          <Button variant="contained" color="error" onClick={closeModalCallback}>
            Cancel
          </Button>
          <Button
            variant="outlined"
            onClick={() => {
              alert(
                `Selected Permissions: ${selectedPermissions.map((p) => p.name).join(", ")}`
              );
              closeModalCallback();
            }}
          >
            Confirm Permission
          </Button>
        </div>
      </div>
    </ModalTemplate>
  );
};

export default AddPermissionModalFromDB;
